<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbox</title>
    <link rel="stylesheet" href="../../../style/ship-planner/ai_agent.css">
</head>

<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-left">
                <div class="bot-icon">ğŸ¤–</div>
                <div class="header-title">
                    <h1>AI Assistant</h1>
                    <p>Siap membantu Anda</p>
                </div>
            </div>
            <button class="clear-btn" onclick="clearChat()" title="Hapus chat">ğŸ—‘ï¸</button>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="message bot">
                <div class="avatar bot">ğŸ¤–</div>
                <div class="message-bubble">Halo! Ada yang bisa saya bantu?</div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="messageInput" placeholder="Ketik pesan Anda..."
                    onkeypress="handleKeyPress(event)">
                <button id="sendBtn" onclick="sendMessage()">ğŸ“¤</button>
            </div>
            <div class="footer-text">
                Powered by AI â€¢ Pastikan untuk mengonfigurasi endpoint API Anda
            </div>
        </div>
    </div>

    <script src="api_agent.js"></script>

    <script>
        let isLoading = false;

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function addMessage(role, content) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = `avatar ${role}`;
            avatar.textContent = role === 'bot' ? 'ğŸ¤–' : 'ğŸ‘¤';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = content;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);

            scrollToBottom();
        }

        function showLoading() {
            const container = document.getElementById('messagesContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message loading active';
            loadingDiv.id = 'loadingIndicator';

            loadingDiv.innerHTML = `
                <div class="avatar bot">ğŸ¤–</div>
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;

            container.appendChild(loadingDiv);
            scrollToBottom();
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();

            if (!message || isLoading) return;

            // Add user message
            addMessage('user', message);
            input.value = '';

            // Disable input
            isLoading = true;
            input.disabled = true;
            sendBtn.disabled = true;
            showLoading();

            try {
                // Endpoint n8n workflow
                const response = await fetch('https://pojer26018.app.n8n.cloud/webhook/chatai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        history: getMessageHistory()
                    }),
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                hideLoading();

                const botMessage = data.message || data.response || data.output || JSON.stringify(data);
                addMessage('bot', botMessage);

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                addMessage('bot', 'Maaf, terjadi kesalahan saat menghubungi server. Pastikan endpoint API sudah dikonfigurasi dengan benar.');
            } finally {
                isLoading = false;
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        function getMessageHistory() {
            const messages = document.querySelectorAll('.message:not(.loading)');
            const history = [];

            messages.forEach(msg => {
                const role = msg.classList.contains('user') ? 'user' : 'assistant';
                const content = msg.querySelector('.message-bubble').textContent;
                history.push({ role, content });
            });

            return history;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function clearChat() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = `
                <div class="message bot">
                    <div class="avatar bot">ğŸ¤–</div>
                    <div class="message-bubble">Halo! Ada yang bisa saya bantu?</div>
                </div>
            `;
        }

        // Focus input on load
        window.addEventListener('load', () => {
            document.getElementById('messageInput').focus();
        });
    </script>
</body>

</html>